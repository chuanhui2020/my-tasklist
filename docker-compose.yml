services:
  # MySQL 数据库服务
  db:
    image: mysql:8.0
    container_name: tasklist-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-tasklist_db}
      MYSQL_USER: ${MYSQL_USER:-taskuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-taskpassword}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    networks:
      - tasklist_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    # 资源限制（1C2G 服务器优化）
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 最多使用 50% CPU
          memory: 512M     # 最多使用 512MB 内存
        reservations:
          cpus: '0.25'     # 保留 25% CPU
          memory: 256M     # 保留 256MB 内存

  # Flask 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: tasklist-backend
    restart: always
    environment:
      # 数据库配置
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-taskuser}:${MYSQL_PASSWORD:-taskpassword}@db:3306/${MYSQL_DATABASE:-tasklist_db}?charset=utf8mb4
      # Flask 配置
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      FLASK_ENV: ${FLASK_ENV:-production}
      # Python 配置
      PYTHONUNBUFFERED: 1
    depends_on:
      db:
        condition: service_healthy
    networks:
      - tasklist_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/tasks', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # 资源限制（1C2G 服务器优化）
    deploy:
      resources:
        limits:
          cpus: '0.3'      # 最多使用 30% CPU
          memory: 384M     # 最多使用 384MB 内存
        reservations:
          cpus: '0.15'     # 保留 15% CPU
          memory: 192M     # 保留 192MB 内存

  # Nginx + Vue 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: tasklist-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - backend
    networks:
      - tasklist_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    # 资源限制（1C2G 服务器优化）
    deploy:
      resources:
        limits:
          cpus: '0.2'      # 最多使用 20% CPU
          memory: 128M     # 最多使用 128MB 内存
        reservations:
          cpus: '0.1'      # 保留 10% CPU
          memory: 64M      # 保留 64MB 内存

volumes:
  mysql_data:
    name: tasklist_mysql_data

networks:
  tasklist_network:
    name: tasklist_network
    driver: bridge
