# 📊 后端详细日志说明

## ✅ 已添加详细日志

现在后端会记录：
- ✅ 请求接收时间
- ✅ 请求路径和方法
- ✅ 客户端 IP
- ✅ 请求头信息
- ✅ 请求体数据
- ✅ 处理耗时
- ✅ 响应数据摘要
- ✅ 错误堆栈跟踪

---

## 📝 日志示例

### 成功请求的完整日志

```
================================================================================
🎯 [API 请求] 收到签文生成请求 - 2025-11-20 19:58:30
================================================================================
📍 请求路径: /api/fortune/generate
🌐 请求方法: POST
🔗 客户端 IP: 192.168.1.100
📋 Content-Type: application/json

📨 请求头:
   User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)...
   Authorization: Bearer eyJhbGciOiJ...abc12345
   Origin: http://localhost:3000
   Referer: http://localhost:3000/fortune

📦 请求体数据:
   {'fortuneNumber': 88}

🎲 解析签号: 88

✅ 验证通过

⏳ 开始生成签文...
--------------------------------------------------------------------------------

🎋 开始生成第 88 签
📋 当前配置:
   AI_SERVICE = gemini
   OPENAI_API_KEY = 未配置
   GEMINI_API_KEY = 已配置 (abc12345)
🎯 决策：使用 Gemini API

============================================================
🤖 [Gemini AI] 开始调用 - 2025-11-20 19:58:30
============================================================
📤 请求 URL: https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:gene...abc12345
📝 提示词长度: 456 字符
⚙️  配置: temperature=0.8, maxTokens=800

发送请求中...
📥 响应状态码: 200
✅ 调用成功！

原始响应结构:
  - candidates 数量: 1
  - finishReason: STOP
  - 生成内容长度: 523 字符

📜 AI 生成的原始内容:
------------------------------------------------------------
```json
{
  "type": "great",
  "typeText": "上上籤",
  "poem": "龍騰雲霄志氣高，鳳凰展翅舞九霄，時來運轉福星照，萬事如意樂逍遙。",
  ...
}
```
------------------------------------------------------------

🔧 检测到 JSON 代码块，正在提取...

✨ 签文解析成功！
  - 签型: 上上籤
  - 签诗: 龍騰雲霄志氣高，鳳凰展翅舞九霄，時來運轉福星照，萬事如意樂逍遙...
  - 解签长度: 142 字
  - 指引数量: 4 条
============================================================

--------------------------------------------------------------------------------
✅ 签文生成完成，耗时: 12.35 秒

📜 签文摘要:
   签型: 上上籤
   签诗: 龍騰雲霄志氣高，鳳凰展翅舞九霄，時來運轉福星...
   解签长度: 142 字
   指引数量: 4 条

📤 [API 响应] 返回成功 200
   总耗时: 12.38 秒
   响应数据大小: ~856 字符
================================================================================
```

---

### 失败请求的日志示例

#### 1. 验证失败（签号无效）

```
================================================================================
🎯 [API 请求] 收到签文生成请求 - 2025-11-20 19:58:45
================================================================================
📍 请求路径: /api/fortune/generate
🌐 请求方法: POST
🔗 客户端 IP: 192.168.1.100
📋 Content-Type: application/json

📦 请求体数据:
   {'fortuneNumber': 999}

🎲 解析签号: 999

❌ 验证失败: 签号必须在 1-100 之间
================================================================================

📤 [API 响应] 返回错误 400
   响应数据: {'error': '签号必须在 1-100 之间'}
================================================================================
```

#### 2. API 调用失败

```
================================================================================
🎯 [API 请求] 收到签文生成请求 - 2025-11-20 19:59:00
================================================================================
...
⏳ 开始生成签文...
--------------------------------------------------------------------------------

🎋 开始生成第 88 签
📋 当前配置:
   AI_SERVICE = gemini
   GEMINI_API_KEY = 已配置 (invalid1)
🎯 决策：使用 Gemini API

============================================================
🤖 [Gemini AI] 开始调用 - 2025-11-20 19:59:00
============================================================
📤 请求 URL: https://...
发送请求中...
📥 响应状态码: 401

❌ API 调用失败
状态码: 401
错误信息: {"error": {"code": 401, "message": "API key not valid."}}
⚠️  降级到备用签文
============================================================

❌ AI 生成异常: Gemini API error: 401
🔄 自动降级到备用签文

--------------------------------------------------------------------------------
✅ 签文生成完成，耗时: 2.15 秒
（使用备用签文）

📤 [API 响应] 返回成功 200
   总耗时: 2.18 秒
================================================================================
```

#### 3. 代码异常

```
================================================================================
🎯 [API 请求] 收到签文生成请求 - 2025-11-20 19:59:15
================================================================================
...

❌ [API 异常] 发生错误
   异常类型: TypeError
   异常信息: 'NoneType' object is not subscriptable
   发生时间: 0.05 秒后

📚 完整堆栈跟踪:
Traceback (most recent call last):
  File "/path/to/fortune_routes.py", line 319, in generate_fortune
    fortune_data = generate_fortune_with_ai(fortune_number)
  File "/path/to/fortune_routes.py", line 45, in generate_fortune_with_ai
    ...
TypeError: 'NoneType' object is not subscriptable

📤 [API 响应] 返回错误 500
   响应数据: {'success': False, 'error': "'NoneType' object is not subscriptable"}
================================================================================
```

---

## 📊 日志字段说明

### 请求阶段
| 字段 | 说明 |
|------|------|
| 🎯 [API 请求] | 请求开始标记 |
| 时间戳 | 请求到达时间 |
| 📍 请求路径 | API 路径 |
| 🌐 请求方法 | HTTP 方法（POST） |
| 🔗 客户端 IP | 发起请求的 IP |
| 📨 请求头 | User-Agent、Authorization 等 |
| 📦 请求体数据 | JSON 数据 |
| 🎲 解析签号 | 提取的签号 |

### 处理阶段
| 字段 | 说明 |
|------|------|
| ✅ 验证通过 | 签号验证成功 |
| ⏳ 开始生成签文 | 开始调用 AI |
| 🎋 开始生成第 X 签 | AI 生成开始 |
| 🤖 [Gemini AI] | Gemini 调用详情 |
| 耗时 | 生成签文花费的时间 |

### 响应阶段
| 字段 | 说明 |
|------|------|
| 📜 签文摘要 | 生成结果概要 |
| 📤 [API 响应] | 响应发送标记 |
| 总耗时 | 从请求到响应的总时间 |
| 响应数据大小 | 返回数据的字符数 |

### 错误阶段
| 字段 | 说明 |
|------|------|
| ❌ [API 异常] | 异常发生标记 |
| 异常类型 | Python 异常类名 |
| 异常信息 | 错误描述 |
| 📚 完整堆栈跟踪 | 详细错误堆栈 |

---

## 🔍 如何使用日志

### 1. 查看实时日志
```bash
# SSH 到服务器
ssh user@your-server

# 查看实时输出
tail -f /path/to/backend/app.log
# 或
tail -f nohup.out
```

### 2. 搜索特定请求
```bash
# 搜索某个签号的请求
grep "解析签号: 88" app.log

# 搜索错误
grep "❌" app.log

# 搜索慢请求（超过 20 秒）
grep -E "总耗时: [2-9][0-9]\." app.log
```

### 3. 统计信息
```bash
# 统计总请求数
grep "🎯 \[API 请求\]" app.log | wc -l

# 统计成功请求
grep "返回成功 200" app.log | wc -l

# 统计失败请求
grep "返回错误" app.log | wc -l

# 平均耗时（需要进一步处理）
grep "总耗时:" app.log
```

---

## 💡 性能监控

通过日志可以监控：

1. **响应时间**
   - 正常：< 15 秒
   - 较慢：15-30 秒
   - 很慢：> 30 秒

2. **成功率**
   - 计算 200 vs 400/500 的比例

3. **AI 调用时间**
   - Gemini：通常 10-20 秒
   - 备用：< 1 秒

4. **错误类型**
   - 验证错误（400）
   - API 错误（401、429）
   - 代码错误（500）

---

## 🎯 故障排查

### 问题：请求很慢
**查看日志**：
```
总耗时: 35.67 秒
```
**原因**：AI API 调用慢
**解决**：检查网络或使用备用签文

### 问题：经常失败
**查看日志**：
```
❌ API 调用失败
状态码: 429
```
**原因**：API 请求过于频繁
**解决**：添加限流或缓存

### 问题：代码异常
**查看日志**：
```
📚 完整堆栈跟踪:
TypeError: ...
```
**原因**：代码 bug
**解决**：根据堆栈修复代码

---

## 📌 注意事项

1. **日志大小**
   - 详细日志会占用较多空间
   - 建议定期清理旧日志

2. **敏感信息**
   - Authorization token 已部分隐藏
   - 但仍包含客户端 IP 等信息

3. **性能影响**
   - 打印日志有轻微性能开销
   - 生产环境可考虑减少日志级别

---

现在重启后端，每次请求都会看到详细的日志输出！
