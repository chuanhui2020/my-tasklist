# 📊 Gemini API 调用日志说明

## 日志输出示例

当您抽签时，后端控制台会输出详细的调用日志：

### 成功调用示例

```
🎋 开始生成第 88 签
📋 当前配置:
   AI_SERVICE = gemini
   OPENAI_API_KEY = 未配置
   GEMINI_API_KEY = 已配置 (abc12345)
🎯 决策：使用 Gemini API

============================================================
🤖 [Gemini AI] 开始调用 - 2025-11-20 19:30:15
============================================================
📤 请求 URL: https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:gene...abc12345
📝 提示词长度: 456 字符
⚙️  配置: temperature=0.8, maxTokens=800

发送请求中...
📥 响应状态码: 200
✅ 调用成功！

原始响应结构:
  - candidates 数量: 1
  - finishReason: STOP
  - 生成内容长度: 523 字符

📜 AI 生成的原始内容:
------------------------------------------------------------
```json
{
  "type": "great",
  "typeText": "上上籤",
  "poem": "龍騰雲霄志氣高，鳳凰展翅舞九霄，時來運轉福星照，萬事如意樂逍遙。",
  "interpretation": "此籤大吉大利，預示著運勢極佳。如龍騰雲霄，鳳凰展翅，正是大展宏圖之時...",
  "advice": [
    {"label": "事業", "value": "把握良機，勇往直前"},
    {"label": "財運", "value": "財源廣進，投資有道"},
    {"label": "感情", "value": "桃花運旺，情投意合"},
    {"label": "健康", "value": "精神飽滿，身體健康"}
  ]
}
```
------------------------------------------------------------

🔧 检测到 JSON 代码块，正在提取...

✨ 签文解析成功！
  - 签型: 上上籤
  - 签诗: 龍騰雲霄志氣高，鳳凰展翅舞九霄，時來運轉福星照，萬事如意樂逍遙...
  - 解签长度: 142 字
  - 指引数量: 4 条
============================================================
```

---

## 日志字段说明

### 1️⃣ 配置信息
```
🎋 开始生成第 88 签
📋 当前配置:
   AI_SERVICE = gemini          ← 使用的 AI 服务
   OPENAI_API_KEY = 未配置      ← OpenAI 状态
   GEMINI_API_KEY = 已配置 (...)← Gemini 状态（显示最后8位）
```

### 2️⃣ 决策信息
```
🎯 决策：使用 Gemini API      ← 最终选择的生成方式
```

可能的决策：
- `使用 OpenAI API` - 配置了 OpenAI
- `使用 Gemini API` - 配置了 Gemini ✅
- `使用备用签文` - 未配置或配置不完整

### 3️⃣ 请求信息
```
📤 请求 URL: https://...       ← API 端点（隐藏完整 Key）
📝 提示词长度: 456 字符        ← 发送给 AI 的提示词大小
⚙️  配置: temperature=0.8      ← AI 参数
```

### 4️⃣ 响应信息
```
📥 响应状态码: 200             ← HTTP 状态码
✅ 调用成功！                  ← 成功标识
```

状态码说明：
- `200` - 成功 ✅
- `400` - 请求参数错误
- `401` - API Key 无效
- `403` - 权限不足
- `429` - 请求过于频繁
- `500` - 服务器错误

### 5️⃣ 响应结构
```
原始响应结构:
  - candidates 数量: 1         ← AI 生成的候选数量
  - finishReason: STOP         ← 完成原因
  - 生成内容长度: 523 字符     ← AI 返回的文本长度
```

finishReason 说明：
- `STOP` - 正常完成 ✅
- `MAX_TOKENS` - 达到最大长度限制
- `SAFETY` - 触发安全过滤
- `RECITATION` - 检测到重复内容

### 6️⃣ 生成内容
```
📜 AI 生成的原始内容:
------------------------------------------------------------
{完整的 JSON 内容或前 500 字符}
------------------------------------------------------------
```

### 7️⃣ 解析结果
```
✨ 签文解析成功！
  - 签型: 上上籤               ← 签的类型
  - 签诗: 龍騰雲霄...          ← 签诗前 50 字
  - 解签长度: 142 字           ← 解签文本长度
  - 指引数量: 4 条             ← 建议条数
```

---

## 错误日志示例

### API Key 无效
```
🎋 开始生成第 88 签
📋 当前配置:
   AI_SERVICE = gemini
   GEMINI_API_KEY = 已配置 (invalid1)
🎯 决策：使用 Gemini API

============================================================
🤖 [Gemini AI] 开始调用 - 2025-11-20 19:30:15
============================================================
📤 请求 URL: https://...
📝 提示词长度: 456 字符

发送请求中...
📥 响应状态码: 401

❌ API 调用失败
状态码: 401
错误信息: {
  "error": {
    "code": 401,
    "message": "API key not valid.",
    "status": "UNAUTHENTICATED"
  }
}
⚠️  降级到备用签文
============================================================

❌ AI 生成异常: Gemini API error: 401
🔄 自动降级到备用签文
```

### 网络超时
```
发送请求中...

⏱️  请求超时（30秒）
⚠️  降级到备用签文
============================================================

❌ AI 生成异常: Gemini API timeout
🔄 自动降级到备用签文
```

### JSON 解析失败
```
📜 AI 生成的原始内容:
------------------------------------------------------------
这是一支上上签，预示着...（非 JSON 格式）
------------------------------------------------------------

❌ JSON 解析失败: Expecting value: line 1 column 1 (char 0)
尝试解析的内容: 这是一支上上签，预示着...
⚠️  降级到备用签文
============================================================
```

---

## 如何查看日志

### Windows PowerShell
```powershell
cd d:\projects\my-tasklist\backend
python app.py
```

日志会直接输出在控制台。

### 保存日志到文件
```powershell
python app.py > logs.txt 2>&1
```

然后查看 `logs.txt` 文件。

### 实时查看日志（推荐）
```powershell
python app.py | Tee-Object -FilePath logs.txt
```

同时在控制台显示并保存到文件。

---

## 日志符号说明

| 符号 | 含义 |
|------|------|
| 🎋 | 开始生成签文 |
| 📋 | 配置信息 |
| 🎯 | 决策信息 |
| 🤖 | AI 调用开始 |
| 📤 | 发送请求 |
| 📥 | 接收响应 |
| ✅ | 成功 |
| ❌ | 失败 |
| ⚠️ | 警告 |
| 🔧 | 处理中 |
| ✨ | 解析成功 |
| 📜 | 内容展示 |
| ⏱️ | 超时 |
| 🔄 | 降级/重试 |

---

## 常见问题排查

### 问题：看不到日志
**原因**：后端没有启动或使用了生产模式
**解决**：确保使用 `python app.py` 启动，而不是 gunicorn

### 问题：日志显示"未配置"
**原因**：`.env` 文件不存在或格式错误
**解决**：
1. 检查 `.env` 文件是否在 `backend` 目录
2. 检查文件内容格式是否正确
3. 重启后端服务

### 问题：状态码 401
**原因**：API Key 无效或过期
**解决**：
1. 检查 API Key 是否正确
2. 访问 https://makersuite.google.com/app/apikey 重新生成
3. 更新 `.env` 文件

### 问题：状态码 429
**原因**：请求过于频繁
**解决**：
1. 等待 1 分钟后重试
2. Gemini 免费版限制：60 次/分钟
3. 系统会自动降级到备用签文

---

## 性能监控

通过日志可以监控：

1. **响应时间**：从"发送请求"到"调用成功"的时间
2. **成功率**：成功 vs 降级的比例
3. **内容长度**：AI 生成内容的字符数
4. **错误类型**：统计各种错误的频率

建议定期查看日志，优化配置和使用策略。
